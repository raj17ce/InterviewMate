<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InterviewMate | AI-Powered Interview Practice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --text-primary: #2b2d42;
            --text-secondary: #8d99ae;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s ease;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .app-logo i {
            font-size: 28px;
        }

        .app-main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 992px) {
            .app-main {
                grid-template-columns: 3fr 2fr;
            }
        }

        .card {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .video-container {
            position: relative;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.5);
            padding: 12px;
            display: flex;
            justify-content: center;
            gap: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .video-controls {
            opacity: 1;
        }

        .video-status {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.recording {
            background: #f72585;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .transcript-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .transcript-content {
            flex-grow: 1;
            background: var(--bg-white);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .transcript-actions {
            display: flex;
            gap: 12px;
        }

        .recognition-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .card {
                padding: 16px;
            }
        }

        /* Meeting ID Modal Styles */
        #meetingIdModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #meetingIdModal > div {
            background: white;
            padding: 32px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            min-width: 320px;
            max-width: 90vw;
            text-align: center;
        }

        #meetingIdModal h2 {
            margin-bottom: 18px;
            font-size: 1.3rem;
            color: var(--primary);
            font-weight: 700;
        }

        #meetingIdModal input {
            padding: 12px 16px;
            width: 80%;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            margin-bottom: 18px;
            outline: none;
        }

        #meetingIdModal button {
            width: 80%;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div id="meetingIdModal">
        <div>
            <h2>Enter Meeting ID</h2>
            <input id="meetingIdInput" type="text" placeholder="Meeting ID" autofocus />
            <br />
            <button id="meetingIdSubmit" class="btn btn-primary">Continue</button>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="filter:blur(2px);pointer-events:none;user-select:none;">
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-video"></i>
                <span>InterviewMate</span>
            </div>
            <div class="app-actions">
                <button class="btn btn-outline" id="helpButton">
                    <i class="fas fa-question-circle"></i>
                    Help
                </button>
            </div>
        </header>

        <main class="app-main">
            <section class="card">
                <div class="card-header">
                    <h2 class="card-title">Interview Session</h2>
                    <div class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Position yourself in frame and click Start to begin</span>
                    </div>
                </div>
                
                <!-- Add question display container -->
                <div class="question-container" style="margin-bottom: 20px; padding: 15px; background: var(--bg-light); border-radius: var(--radius-sm); border: 1px solid rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 10px; font-size: 16px; color: var(--text-secondary);">Current Question:</h3>
                    <p id="currentQuestion" style="font-size: 18px; color: var(--text-primary); font-weight: 500;">Waiting for question...</p>
                </div>

                <div class="video-container">
                    <video autoplay id="videoElement"></video>
                    <div class="video-status">
                        <span class="status-indicator" id="recordingIndicator"></span>
                        <span id="statusText">Ready</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" id="startButton">
                        <i class="fas fa-microphone"></i>
                        Start Recording
                    </button>
                    <button class="btn btn-outline" id="nextButton">
                        <i class="fas fa-forward"></i>
                        Next Question
                    </button>
                </div>
            </section>

            <section class="card transcript-container">
                <div class="card-header">
                    <h2 class="card-title">Your Response</h2>
                    <div class="tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Your speech will be transcribed here</span>
                    </div>
                </div>
                
                <div class="transcript-content" id="transcript">
                    Your transcribed response will appear here after you start speaking...
                </div>
                
                
                <div class="recognition-status">
                    <i class="fas fa-info-circle"></i>
                    <span id="recognitionStatus">Ready to record</span>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Clear localStorage on page refresh/unload
        window.onbeforeunload = function() {
            localStorage.removeItem('interviewData');
            localStorage.removeItem('meetingId');
        };

        // Access the webcam
        const video = document.getElementById('videoElement');
        const startButton = document.getElementById('startButton');
        const nextButton = document.getElementById('nextButton');
        const transcriptOutput = document.getElementById('transcript');
        const statusText = document.getElementById('statusText');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const recognitionStatus = document.getElementById('recognitionStatus');
        const helpButton = document.getElementById('helpButton');

        // Initialize webcam
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
            })
            .catch((error) => {
                console.error("Error accessing webcam: ", error);
                transcriptOutput.textContent = "⚠️ Error accessing webcam. Please check your camera permissions.";
            });
        } else {
            alert("Your browser does not support accessing the webcam.");
        }

        // Speech recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;

        let fullTranscript = '';
        let isListening = false;

        // Handle the Start button
        startButton.addEventListener('click', () => {
            if (!isListening) {
                fullTranscript = '';
                transcriptOutput.textContent = 'Listening to your response...';
                transcriptOutput.style.color = '#666';
                recognition.start();
                isListening = true;
                
                // Update UI
                startButton.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-outline');
                statusText.textContent = "Recording";
                recordingIndicator.classList.add('recording');
                recognitionStatus.textContent = "Speech recognition active";
            } else {
                recognition.stop();
                isListening = false;
                
                // Update UI
                startButton.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                startButton.classList.remove('btn-outline');
                startButton.classList.add('btn-primary');
                statusText.textContent = "Paused";
                recordingIndicator.classList.remove('recording');
                recognitionStatus.textContent = "Speech recognition paused";
            }
        });

        nextButton.addEventListener('click', async () => {
            if (isListening) {
                recognition.stop();
                isListening = false;
                
                // Update UI
                startButton.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                startButton.classList.remove('btn-outline');
                startButton.classList.add('btn-primary');
                statusText.textContent = "Ready";
                recordingIndicator.classList.remove('recording');
                recognitionStatus.textContent = "Ready for next question";
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            // Fetch next question
            try {
                const response = await fetch(`http://10.40.1.152:3000/api/questions/generate?interview_id=${window.meetingId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Fetched next question:', data);
                    if (data.data.question_text) {
                        console.log('Inside if block');
                        const questionElement = document.getElementById('currentQuestion');
                        questionElement.textContent = data.data.question_text;

                        // Clear previous transcript and show question
                        fullTranscript = '';
                        // transcriptOutput.textContent = "Question: " + data.data.question_text;
                        // transcriptOutput.style.color = 'var(--text-primary)';

                        // Speak the new question
                        const utterance = new SpeechSynthesisUtterance(data.data.question_text);
                        utterance.rate = 0.9;
                        utterance.pitch = 1;
                        
                        utterance.onend = () => {
                            if (!isListening) {
                                startButton.click(); // Start recording when speech ends
                            }
                        };

                        window.speechSynthesis.speak(utterance);
                    } else {
                        console.log('No question text found');
                    }
                }
            } catch (error) {
                console.error('Error fetching next question:', error);
                recognitionStatus.textContent = "Error fetching next question";
            }
        });

        recognition.onresult = (event) => {
            const currentTranscript = event.results[event.results.length - 1][0].transcript;
            fullTranscript += currentTranscript + ' ';
            
            // Update the transcript in real-time
            transcriptOutput.textContent = fullTranscript.trim();
            transcriptOutput.style.color = 'var(--text-primary)';
            
            console.log("Transcribing:", currentTranscript);
        };

        recognition.onend = () => {
            if (!isListening) {
                if (fullTranscript.trim()) {
                    // Final transcript is already displayed in real-time
                    recognitionStatus.textContent = "Recording stopped";
                } else {
                    transcriptOutput.textContent = "No speech detected. Try again by clicking Start Recording.";
                    transcriptOutput.style.color = 'var(--warning)';
                    recognitionStatus.textContent = "No speech detected";
                }
            } else {
                // If it ended unexpectedly but we're still supposed to be listening
                recognition.start();
            }
        };

        recognition.onerror = (event) => {
            console.error("Speech recognition error: ", event.error);
            recognitionStatus.textContent = `Error: ${event.error}. Try again.`;
            isListening = false;
            startButton.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
            startButton.classList.remove('btn-outline');
            startButton.classList.add('btn-primary');
            statusText.textContent = "Error";
            recordingIndicator.classList.remove('recording');
        };

        // Help button functionality
        helpButton.addEventListener('click', () => {
            alert("InterviewMate Instructions:\n\n1. Position yourself in the camera frame\n2. Click 'Start Recording' to begin speech recognition\n3. Speak clearly to answer the interview question\n4. Click 'Stop Recording' to pause or 'Next Question' to finish\n5. Your transcribed response will appear in the right panel\n6. Use the Copy or Save buttons to keep your response");
        });

        // Meeting ID modal logic
        const meetingIdModal = document.getElementById('meetingIdModal');
        const meetingIdInput = document.getElementById('meetingIdInput');
        const meetingIdSubmit = document.getElementById('meetingIdSubmit');
        const mainApp = document.getElementById('mainApp');

        // Check for existing interview data
        const checkExistingSession = () => {
            const savedInterviewData = localStorage.getItem('interviewData');
            const savedMeetingId = localStorage.getItem('meetingId');
            
            if (savedInterviewData && savedMeetingId) {
                const interviewData = JSON.parse(savedInterviewData);
                window.meetingId = savedMeetingId;
                window.interviewData = { data: interviewData };
                
                // Hide modal and show main app
                meetingIdModal.style.display = 'none';
                mainApp.style.filter = '';
                mainApp.style.pointerEvents = '';
                mainApp.style.userSelect = '';
                
                // Update UI with interview data
                const cardTitle = document.querySelector('.card-title');
                cardTitle.textContent = `Interview: ${interviewData.role}`;
                
                console.log('Restored interview data:', interviewData);
            }
        };
        
        // Check for existing session when page loads
        checkExistingSession();
        
        meetingIdSubmit.addEventListener('click', async () => {
            const meetingId = meetingIdInput.value.trim();
            if(meetingId) {
                try {
                    // Show loading state
                    const originalText = meetingIdSubmit.textContent;
                    meetingIdSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                    meetingIdSubmit.disabled = true;
                    
                    // Make API request to verify the meeting ID
                    const response = await fetch(`http://10.40.1.152:3000/api/interviews/interview-id/${meetingId}`);

                    if (response.ok) {
                        // If successful, show the main app
                        const data = await response.json();
                        console.log('Interview data:', data);
                        
                        // Store interview data in localStorage
                        const interviewData = {
                            id: data.data.id,
                            interview_id: data.data.interview_id,
                            interviewee_name: data.data.interviewee_name,
                            role: data.data.role,
                            interview_time: data.data.interview_time,
                            technologies: data.data.technologies,
                            status: data.data.status,
                            created_at: data.data.created_at,
                            updated_at: data.data.updated_at
                        };
                        localStorage.setItem('interviewData', JSON.stringify(interviewData));
                        localStorage.setItem('meetingId', meetingId);
                        
                        // Hide modal and show main app
                        meetingIdModal.style.display = 'none';
                        mainApp.style.filter = '';
                        mainApp.style.pointerEvents = '';
                        mainApp.style.userSelect = '';
                        
                        // Store meeting ID and interview data in window for immediate access
                        window.meetingId = meetingId;
                        window.interviewData = data;
                        
                        // Update UI with interview data
                        document.querySelector('.card-title').textContent = `Interview: ${data.data.role}`;

                        // Fetch and speak the first question
                        try {
                            const questionResponse = await fetch(`http://10.40.1.152:3000/api/questions/generate?interview_id=${meetingId}`);
                            if (questionResponse.ok) {
                                const questionData = await questionResponse.json();
                                if (questionData.question) {
                                    const questionElement = document.getElementById('currentQuestion');
                                    questionElement.textContent = questionData.question;

                                    // Show question in transcript
                                    transcriptOutput.textContent = "Question: " + questionData.question;
                                    transcriptOutput.style.color = 'var(--text-primary)';

                                    // Initialize speech synthesis
                                    const synth = window.speechSynthesis;
                                    const utterance = new SpeechSynthesisUtterance(questionData.question);
                                    
                                    // Configure speech settings
                                    utterance.rate = 0.9; // Slightly slower for clarity
                                    utterance.pitch = 1;
                                    
                                    // When speech ends, start recording automatically
                                    utterance.onend = () => {
                                        if (!isListening) {
                                            startButton.click(); // Simulate click to start recording
                                        }
                                    };

                                    // Speak the question
                                    synth.speak(utterance);
                                }
                            } else {
                                throw new Error('Failed to fetch question');
                            }
                        } catch (error) {
                            console.error('Error fetching first question:', error);
                            recognitionStatus.textContent = "Error fetching question";
                        }
                    }else {
                        // If error, show error message
                        throw new Error('Invalid meeting ID');
                    }
                } catch (error) {
                    console.error('Error verifying meeting ID:', error);
                    meetingIdInput.style.borderColor = 'var(--warning)';
                    
                    // Add error message below input
                    const errorMsg = document.getElementById('meetingIdError') || document.createElement('p');
                    errorMsg.id = 'meetingIdError';
                    errorMsg.textContent = 'Invalid meeting ID. Please try again.';
                    errorMsg.style.color = 'var(--warning)';
                    errorMsg.style.margin = '0 0 16px 0';
                    errorMsg.style.fontSize = '14px';
                    
                    if (!document.getElementById('meetingIdError')) {
                        meetingIdInput.insertAdjacentElement('afterend', errorMsg);
                    }
                    
                    meetingIdInput.focus();
                } finally {
                    // Reset button
                    meetingIdSubmit.innerHTML = 'Continue';
                    meetingIdSubmit.disabled = false;
                }
            } else {
                meetingIdInput.style.borderColor = 'var(--warning)';
                meetingIdInput.focus();
            }
        });
        
        meetingIdInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') meetingIdSubmit.click();
        });
    </script>
</body>
</html>
